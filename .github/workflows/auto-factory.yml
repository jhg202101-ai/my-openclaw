name: Gemini API smoke test

on:
  workflow_dispatch:
  push:

jobs:
  gemini-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Gemini smoke test (gemini-2.5-flash)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -e

          echo "▶ Installing Gemini SDK"
          npm install @google/generative-ai

          echo "▶ Running Gemini smoke test with models/gemini-2.5-flash"
          node << 'EOF'
          const { GoogleGenerativeAI } = require("@google/generative-ai");

          const apiKey = process.env.GEMINI_API_KEY;
          if (!apiKey) {
            console.error("❌ GEMINI_API_KEY is missing");
            process.exit(1);
          }

          const genAI = new GoogleGenerativeAI(apiKey);
          const model = genAI.getGenerativeModel({
            model: "models/gemini-2.5-flash"
          });

          async function main() {
            const result = await model.generateContent(
              "Hello from GitHub Actions. Reply with one short sentence."
            );
            console.log("▶ Gemini response:");
            console.log(result.response.text());
          }

          main().catch(err => {
            console.error("❌ Gemini API error");
            console.error(err);
            process.exit(1);
          });
          EOF

          echo "✅ Smoke test finished"
